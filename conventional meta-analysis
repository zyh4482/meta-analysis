# Install required packages #
install.packages("meta")
install.packages("metafor")
# After installation, above codes do not need to be run again.

##### Start Analysis #####

#load packages to environment #
library(meta)
library(metafor)

# Meta-analysis R package manual in this study #
# https://cran.r-project.org/web/packages/meta/meta.pdf

# Save data of each outcome as seperate txt with header:
# author  year  refs(here it is the citation number in your paper)  event.e n.e event.c n.c #
# .e refers to experiment group, .c refers to control group #
# You can set refs with a series and later changed in your code #

# Use \\  or / to set your working directory, DO NOT use "\" as it is set as default in Windows #
setwd("Path\\to\\your\\data.txt")

# Import data #
data<-read.table("*.txt",sep = "\t",header = T)

# Create JAMA layout labels (Optional if you want to have JAMA layout in forest plot)#
# reference number of each study in your paper, below is example #

data$lab<-JAMAlabels(author = author, year= year, citation = refs, data = data )

# Meta-analysis via generalized linear model (Mixed effect) #
meta<- metabin(event.e = event.e,n.e = n.e,event.c = event.c,n.c = n.c,studlab = lab,
               data = data, method = "GLMM", sm= "OR", 
               model.glmm = "UM.RS", #UM.RS for random study effects in mixed-effect model,UM.FS for fixed one
               method.bias = "Begg", #Begg test, not sure if required for funnel.meta. Test it yourself
               backtransf = T, #Optional, backtransform from logOR to OR
               label.e = "Monoclonal Antibody",
               label.c = "Placebo")


# Forrest plot #
pdf("forest.pdf", width = 10,height = 8)
forest.meta(meta, studlab = T, comb.fixed=T,comb.random=T, overall=T,text.fixed = "Fixed model",
            text.random = "Random model", layout = "JAMA",
            label.right = "High response", col.label.right = "green",
            label.left = "Low response", col.label.left = "pink"
            )
dev.off()

# Funnel plot #
pdf("funnel.pdf", width = 10,height = 8)
funnel.meta(meta, comb.fixed=meta$comb.fixed,lty.fixed = 2, col.fixed = "grey",
       comb.random=meta$comb.random, lty.random = 9, col.random = "black",
       studlab = T, cex.studlab = 0.8, pos.studlab = 2, cex = 1
       )
dev.off()

# Heterogeneity plot #
pdf("heterogeneity.pdf", width = 10,height = 8)
baujat.meta(meta, yscale = 1,
            xlim = c(0,1),
            ylim = c(0,1),
            xlab = "Contribution to overall heterogeneity",
            ylab = "Influence on overall result", cex =1, col = "black",
            studlab = T, cex.studlab = 0.8,pos.studlab = 2)
dev.off()

# Sensitivity analysis #
install.packages("metasens")
library(metasens)

copas<-copas(meta)
plot.copas(copas,caption = c("Funnel plot", "Contour plot", "Treatment effect plot",
                              "P-value for residual selection bias")
)
summary(copas)

# For interpretation of senstivity analysis, please check interpretation section in the manual #
# Manual: https://cran.r-project.org/web/packages/metasens/metasens.pdf #

## Another package for Publication Bias detection is available, it's your choice #
# Manual: https://cran.r-project.org/web/packages/PublicationBias/PublicationBias.pdf
# install.package("PublicationBias")
# library(PublicationBias)



# Statistical interpretaion and explanation reference # 
# https://doi.org/10.1002/hsr2.178

## Some statistics ##
# Double arcsine transformation #
#data$tpda= asin(sqrt(data$events/(data$total+1)))+asin(sqrt((data$events+1)/(data$total+1)))
#data$setpda= sqrt(1/(data$total+1))

# Back-tranform to interpretable porprotion #
# P = (sin(tpda/2))^2 #
#sin(2.169/2)^2 # for estimate effect size
#sin(2.962/2)^2 # for lower 95% CI
#sin(2.376/2)^2 # for upper 95% CI


# Single proportion pooling #
# If the events are rare, and you would like to report a single proportion for each arm, try metaprop #
meta<- metaprop(event = events, n= total, studlab = lab, 
                data= data, method = "Inverse", comb.fixed = T, comb.random = T,
                sm= "PFT", #PFT represented Freeman-Tukey Double arcsine transformation
)
# Some examples #
# https://stackoverflow.com/questions/48371367/calculate-exact-proportion-using-metaprop-meta-package-in-r


# Important information for metaprop# 
#please refers to "Choice of transformation / meta-analysis method:" section in the manual#
# when set "inverse" model with PFT, it'll generate individual study weights
# Otherwise, using "GLMM" model seems to be more recommended by analysts
# Schwarzer et al. (2019) Warton & Hui (2011) Barendregt et al. (2013)
# See in the manual #
